{% extends 'conductor/layout.html' %}

{% block content %}
{{ super() }}
<div class="container">

  <div id="js-loading-spinner">
  </div>

  <div id="js-table-container-progress" class="row hidden">
  <h3>
    In progress <i class="fa fa-question-circle" aria-hidden="true" data-toggle="tooltip" data-placement="right" data-title="Contracts that have not moved in seven days are marked yellow. Contracts that have not moved in fourteen days are marked red."></i>
  </h3>

    <div class="checkbox">
      <label>
        <input type="checkbox" checked id="js-show-only-mine"><strong>Show only my contracts</strong>
      </label>
    </div>

    <table class="display" id="js-table-progress">
      <thead>
        {% set type = 'in_progress' %}
        {% include 'conductor/table/header.html' %}

      </thead>
      <tbody>
        {% for contract in in_progress %}
        <tr class="{%- if days_from_today(contract.entered) > 14 -%}contract-row-expiring-danger
        {%- elif days_from_today(contract.entered) > 7 -%}contract-row-expiring-warning
        {%- endif -%}">
          {% include 'conductor/table/row.html' %}
        </tr>
        {% endfor %}
      </tbody>
    </table><!-- in progress contracts table -->

  <hr>
  </div>

  <div id="js-table-container-all" class="row hidden">
    <h3>All Contracts <i class="fa fa-question-circle" aria-hidden="true" data-toggle="tooltip" data-placement="right" data-title="Contracts expiring in less than 60 days are marked red. Contracts expiring in less than 120 days are marked yellow."></i></h3>

    <table class="display" id="js-table-all">
      <thead>
        {% set type = 'all' %}
        {% include 'conductor/table/header.html' %}
      </thead>
      <tbody>
        {% for contract in _all %}
        <tr class="{%- if days_from_today(contract.expiration_date) < 60 -%}contract-row-expiring-danger
        {%- elif days_from_today(contract.expiration_date) < 120 -%}contract-row-expiring-warning
        {%- endif -%}">
          {% include 'conductor/table/row.html' %}
        </tr>
        {% endfor %}
      </tbody>
    </table><!-- all contracts table -->

  <hr>
  </div>

</div>
{% endblock %}

{% block js %}
{{ super() }}
<script>
$(document).ready(function() {
  $.fn.dataTableExt.afnFiltering.push(function (oSettings, aData, iDataIndex) {
    if (oSettings.sTableId === "js-table-progress") {
      if ($('#js-show-only-mine').is(':checked')) {
        return aData[6] === currentUser.split('@')[0];
      }
      return true;
    }
    return true;
  });

  var progressTable = $('#js-table-progress').DataTable({
    // order by expiration date -- column 4
    'order': [[4, 'asc']],
    // use column 3 (actual timestamps) as a sort proxy for
    // column 4 (formatted "days since")
    'aoColumnDefs': [
      { 'bVisible': false, 'aTargets': [3, 6] },
      { 'iDataSort': 3, 'aTargets': [4] }
    ],
  });

  $('#js-table-all').dataTable({
    // order by expiration date -- column 4
    'order': [[4, 'asc']],
    // use column 3 (actual timestamps) as a sort proxy for
    // column 4 (formatted "days since")
    'aoColumnDefs': [
      { 'bVisible': false, 'aTargets': [3, 6] },
      { 'iDataSort': 3, 'aTargets': [4] }
    ]
  });

  $('#js-show-only-mine').on('change', function() {
    progressTable.draw();
  });

  $('#js-loading-spinner').addClass('hidden');
  $('#js-table-container-progress').removeClass('hidden');
  $('#js-table-container-upcoming').removeClass('hidden');
  $('#js-table-container-all').removeClass('hidden');

});
</script>
{% endblock %}
